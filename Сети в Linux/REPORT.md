# Сети в Linux

- Установил **Ubuntu 20.04 Server LTS** без графического интерфейса, используя программу для виртуализации — VirtualBox
- Проверил версию Ubuntu командой `cat /etc/issue`

![Версия Ubuntu](../datasets/photo1.png)  
*Рис. 1: Версия Ubuntu*
## Part 1. Инструмент **ipcalc**
## 1.1. Сети и маски 
## 1.1.1 Адрес сети
- Проверил адрес сети командой `ipcalc 192.167.38.54/13`
- Адрес сети : 192.160.0.0/13

![Результат выполнения команды ipcalc](../datasets/photo2.png)  
*Рис. 2: Результат выполнения команды ipcalc*
## 1.1.2 Перевод маски в префиксную, двоичную и обычную запись
## 1.1.2.1 /255.255.255.0
- Проверил маску командой `ipcalc 192.168.1.1/255.255.255.0`
- Префикс : /24
- Двоичная : 11111111.11111111.11111111.00000000

![Результат выполнения команды ipcalc](../datasets/photo3.png)  
*Рис. 3: Результат выполнения команды ipcalc*

## 1.1.2.2 /15
- Проверил маску командой `ipcalc 192.167.38.54/15`
- Обычная : 255.254.0.0
- Двоичная : 11111111.11111110.00000000.00000000

![Результат выполнения команды ipcalc](../datasets/photo4.png)  
*Рис. 4: Результат выполнения команды ipcalc*

## 1.1.2.3 /11111111.11111111.11111111.11110000
- Проверил маску командой `ipcalc 192.167.38.54/28`
- Обычная : 255.255.255.240
- Префикс : /28

![Результат выполнения команды ipcalc](../datasets/photo5.png)  
*Рис. 5: Результат выполнения команды ipcalc*

## 1.1.2.4 Минимальный и максимальный хост в сети 12.167.38.4 
- Маска : /8
- Минимальный IP хоста : 12.0.0.1
- Максимальный IP хоста : 12.255.255.254

![Результат выполнения команды ipcalc](../datasets/photo6.png)  
*Рис. 6: Результат выполнения команды ipcalc*
- Маска : 11111111.11111111.00000000.00000000
- Минимальный IP хоста : 12.167.0.1
- Максимальный IP хоста : 12.167.255.254

![Результат выполнения команды ipcalc](../datasets/photo7.png)  
*Рис. 7: Результат выполнения команды ipcalc*
- Маска : 255.255.254.0
- Минимальный IP хоста : 12.167.38.1
- Максимальный IP хоста : 12.167.39.254

![Результат выполнения команды ipcalc](../datasets/photo8.png)  
*Рис. 8: Результат выполнения команды ipcalc*
- Маска : /4
- Минимальный IP хоста : 0.0.0.1
- Максимальный IP хоста : 15.255.255.254

![Результат выполнения команды ipcalc](../datasets/photo9.png)  
*Рис. 9: Результат выполнения команды ipcalc*

## 1.2 localhost
---
- IP: 194.34.23.100
- Ответ : Нельзя обратиться к приложению, работающему на localhost

![Результат выполнения команды ipcalc](../datasets/photo10.png)  
*Рис. 10: Результат выполнения команды ipcalc*

---
- IP: 127.0.0.2
- Ответ : Можно обратиться к приложению, работающему на localhost

![Результат выполнения команды ipcalc](../datasets/photo11.png)  
*Рис. 11: Результат выполнения команды ipcalc*

---
- IP: 127.1.0.1
- Ответ : Можно обратиться к приложению, работающему на localhost

![Результат выполнения команды ipcalc](../datasets/photo12.png)  
*Рис. 12: Результат выполнения команды ipcalc*

---
- IP: 128.0.0.1
- Ответ : Нельзя обратиться к приложению, работающему на localhost

![Результат выполнения команды ipcalc](../datasets/photo13.png)  
*Рис. 13: Результат выполнения команды ipcalc*

---
## 1.3 Диапазоны и сегменты сетей
Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных?

---
- IP: 10.0.0.45
- Ответ : частный IP

![Результат выполнения команды ipcalc](../datasets/photo14.png)  
*Рис. 14: Результат выполнения команды ipcalc*

---
- IP: 134.43.0.2
- Ответ : публичный IP

![Результат выполнения команды ipcalc](../datasets/photo15.png)  
*Рис. 15: Результат выполнения команды ipcalc*

---
- IP: 192.168.4.2
- Ответ : частный IP

![Результат выполнения команды ipcalc](../datasets/photo16.png)  
*Рис. 16: Результат выполнения команды ipcalc*

---
- IP: 172.20.250.4
- Ответ : частный IP

![Результат выполнения команды ipcalc](../datasets/photo17.png)  
*Рис. 17: Результат выполнения команды ipcalc*

---
- IP: 172.0.2.1
- Ответ : публичный IP

![Результат выполнения команды ipcalc](../datasets/photo18.png)  
*Рис. 18: Результат выполнения команды ipcalc*

---
- IP: 192.172.0.1
- Ответ : публичный IP

![Результат выполнения команды ipcalc](../datasets/photo19.png)  
*Рис. 19: Результат выполнения команды ipcalc*

---
- IP: 172.68.0.2
- Ответ : публичный IP

![Результат выполнения команды ipcalc](../datasets/photo20.png)  
*Рис. 20: Результат выполнения команды ipcalc*

---
- IP: 172.16.255.255
- Ответ : частный IP

![Результат выполнения команды ipcalc](../datasets/photo21.png)  
*Рис. 21: Результат выполнения команды ipcalc*

---
- IP: 10.10.10.10
- Ответ : частный IP

![Результат выполнения команды ipcalc](../datasets/photo22.png)  
*Рис. 22: Результат выполнения команды ipcalc*

---
- IP: 192.169.168.1
- Ответ : публичный IP

![Результат выполнения команды ipcalc](../datasets/photo23.png)  
*Рис. 23: Результат выполнения команды ipcalc*

---
## Какие из перечисленных IP-адресов шлюза возможны у сети 10.10.0.0/18?

---
- 10.0.0.1 : не входит в диапозон
- 10.10.0.2 : входит в диапозон
- 10.10.10.10 : входит в диапозон
- 10.10.100.1 : не входит в диапозон
- 10.10.1.255 : входит в диапозон

![Результат выполнения команды ipcalc](../datasets/photo24.png)  
*Рис. 24: Результат выполнения команды ipcalc*

---
## Part 2. Статическая маршрутизация между двумя машинами
- Команда `ip a` - просмотр существующих сетевых интерфейсов

![Результат выполнения команды ip a*](../datasets/photo25.png)  
*Рис. 25: Результат выполнения команды ip a*

---

![Результат изменения 00-installer-config.yaml для каждой машины](../datasets/photo26.png)  
*Рис. 26: Результат изменения 00-installer-config.yaml для каждой машины*

---

![Результат применения sudo netplan apply](../datasets/photo27.png)  
*Рис. 27: Результат применения sudo netplan apply*

---
## 2.1. Добавление статического маршрута вручную

---

![Cтатический маршрут от одной машины до другой при помощи команды вида ip r add (WS1)](../datasets/photo28.png)  
*Рис. 28: Cтатический маршрут от одной машины до другой при помощи команды вида ip r add (WS1)*

![Cтатический маршрут от одной машины до другой при помощи команды вида ip r add (WS2)](../datasets/photo29.png)  
*Рис. 29: Cтатический маршрут от одной машины до другой при помощи команды вида ip r add (WS2)*

---

![Пинг (WS1)](../datasets/photo30.png)  
*Рис. 30: Пинг (WS1)*

![Пинг (WS2)](../datasets/photo31.png)  
*Рис. 31: Пинг (WS2)*

## 2.2. Добавление статического маршрута с сохранением

![Cтатический маршрут (WS1)](../datasets/photo32.png)  
*Рис. 32: Cтатический маршрут (WS1)*

![Cтатический маршрут (WS2)](../datasets/photo33.png)  
*Рис. 33: Cтатический маршрут (WS2)*

---

## Part 3. Утилита **iperf3**
- 8 Mbps = 1 MB/s
- 100 MB/s = 800 000 Kbps 
- 1 Gbps = 1000 Mbps
---
![ Cкорость соединения между ws1 и ws2](../datasets/photo34.png)  
*Рис. 34: Cкорость соединения между ws1 и ws2*

![ Cкорость соединения между ws1 и ws2](../datasets/photo35.png)  
*Рис. 35: Cкорость соединения между ws1 и ws2*

---
## Part 4. Сетевой экран
![ Cкорость соединения между ws1 и ws2](../datasets/photo36.png)  
*Рис. 36: Запуск и содержание обоих файлов /etc/firewall.sh*

![ Cкорость соединения между ws1 и ws2](../datasets/photo37.png)  
*Рис. 37: Результат*

Оба файла содержат технически одинаковые правила (DROP echo-reply и ACCEPT echo-reply), но в разном порядке. Из-за принципа последовательной обработки iptables это приводит к диаметрально противоположному поведению системы:

- ws1 не будет отвечать на ping, так как первое правило DROP перехватывает все пакеты echo-reply

- ws2 будет нормально отвечать на ping, так как первое правило ACCEPT пропускает пакеты echo-reply

---
![ Cкорость соединения между ws1 и ws2](../datasets/photo38.png)  
*Рис. 38: Ping на ws1*

![ Cкорость соединения между ws1 и ws2](../datasets/photo39.png)  
*Рис. 39: Ping на ws2 и nmap: хост машины запущен*

---
## Part 5. Статическая маршрутизация сети
## 5.1. Настройка адресов машин
---
- Настройка конфигурации машин

![ Рисунок](../datasets/photo40.png)  
*Рис. 40: Конфигурация машины WS11*

![ Рисунок](../datasets/photo41.png)  
*Рис. 41: Конфигурация машины WS21*

![ Рисунок](../datasets/photo42.png)  
*Рис. 42: Конфигурация машины WS22*

![ Рисунок](../datasets/photo43.png)  
*Рис. 43: Конфигурация машины R1*

![ Рисунок](../datasets/photo44.png)  
*Рис. 44: Конфигурация машины R2*

---
![ Рисунок](../datasets/photo45.png)  
*Рис. 45: Проверка адресов машин с помощью команды ip -4 a*

---
![ Рисунок](../datasets/photo46.png)  
*Рис. 46: Ping WS22 с W21*

![ Рисунок](../datasets/photo47.png)  
*Рис. 47: Ping R1 с WS11*

## 5.2. Включение переадресации IP-адресов
- Включение переадресации IP с помощью команды `sysctl -w net.ipv4.ip_forward=1`

![ Рисунок](../datasets/photo48.png)  
*Рис. 48: Включение переадресации IP*

![ Рисунок](../datasets/photo49.png)  
*Рис. 49: Добавил в файл /etc/sysctl.conf следующую строку: `net.ipv4.ip_forward = 1`*

## 5.3. Установка маршрута по умолчанию

![ Рисунок](../datasets/photo50.png)  
*Рис. 50: Установка маршрута по умолчанию W11*

![ Рисунок](../datasets/photo51.png)  
*Рис. 51: Установка маршрута по умолчанию W21*

![ Рисунок](../datasets/photo52.png)  
*Рис. 52: Установка маршрута по умолчанию W22*

![ Рисунок](../datasets/photo53.png)  
*Рис. 53: Проверка маршрутизации `ip r`*

---
- Пропинговал с ws11 роутер r2 и показал на r2, что пинг доходит.

![ Рисунок](../datasets/photo54.png)  
*Рис. 54: Ping доходит до R2*

## 5.4. Добавление статических маршрутов

![ Рисунок](../datasets/photo56.png)  
*Рис. 55: Cодержание обоих файлов netplan роутеров*

![ Рисунок](../datasets/photo55.png)  
*Рис. 56: Маршрутизация роутеров*

---
![ Рисунок](../datasets/photo57.png)  
*Рис. 57: Запуск команд на WS11*

Объяснение: более специфичный маршрут (10.10.0.0/18) всегда имеет приоритет над менее специфичным (0.0.0.0/0) согласно правилу longest prefix match (наибольшее соответствие префикса).

## 5.5. Построение списка маршрутизаторов

![Рисунок](../datasets/photo59.png)  
*Рис. 58: Трафик на R1 `tcpdump -tnv -i enp0s3`*

![Рисунок](../datasets/photo58.png)  
*Рис. 59: Маршрутизация трафика `traceroute`*

Объяснение: traceroute обнаруживает маршрут, отправляя пакеты с TTL=1,2,3… и анализируя ICMP-ответы «Time Exceeded» от каждого маршрутизатора на пути, пока не получит от цели ответ «Port Unreachable». Сеть 10.10.0.0/24 работает.
10.10.0.1 и 10.10.0.2 доступны друг другу на канальном и сетевом уровне.

## 5.6. Использование протокола ICMP при маршрутизации
- Запустил на r1 перехват сетевого трафика, проходящего через eth0, с помощью команды tcpdump -n -i eth0 icmp.
Затем с ws11 пропинговал несуществующий IP 10.30.0.111 командой ping -c 1 10.30.0.111.

![Рисунок](../datasets/photo61.png)  
*Рис. 60: Пропинговал несуществующий IP 10.30.0.111*

![Рисунок](../datasets/photo60.png)  
*Рис. 61: ICMP-пакеты*

---

![Рисунок](../datasets/photo62.png)  
*Рис. 62: Сохранил дампы образов виртуальных машин*

## Part 6. Динамическая настройка IP с помощью **DHCP**

![Рисунок](../datasets/photo63.png)  
*Рис. 63: Настройка DHCP-сервера на R2 через файл /etc/dhcp/dhcpd.conf*

![Рисунок](../datasets/photo64.png)  
*Рис. 64: Прописал в файле /etc/resolv.conf DNS-сервер 8.8.8.8*

![Рисунок](../datasets/photo65.png)  
*Рис. 65: Перезагрузил службу DHCP командой `systemctl restart isc-dhcp-server`*

![Рисунок](../datasets/photo66.png)  
*Рис. 66: Командой `ip a` проверил, что WS21 получил IP 10.20.0.2/26*

![Рисунок](../datasets/photo68.png)  
*Рис. 67: Командой `ip a` проверил, что WS22 получил IP 10.20.0.3/26*

![Рисунок](../datasets/photo_67.png)  
*Рис. 68: Проверка на R2*

---
![Рисунок](../datasets/photo69.png)  
*Рис. 69: MAC адрес у WS11 (etc/netplan/00-installer-config.yaml)*

![Рисунок](../datasets/photo70.png)  
*Рис. 70: Выдача адресов с жесткой привязкой к MAC-адресу WS11*

![Рисунок](../datasets/photo71.png)  
*Рис. 71: Перезагрузил службу DHCP командой `systemctl restart isc-dhcp-server`*

![Рисунок](../datasets/photo72.png)  
*Рис. 72: Прописал в файле /etc/resolv.conf DNS-сервер 8.8.8.8*

![Рисунок](../datasets/photo73.png)  
*Рис. 73: Запрос нового IP для WS11*

___
![Рисунок](../datasets/photo74.png)  
*Рис. 74: IP до обновления для WS21*

![Рисунок](../datasets/photo75.png)  
*Рис. 75: IP после обновления для WS21*

![Рисунок](../datasets/photo76.png)  
*Рис. 76: Сохранил дампы образов виртуальных машин*
___
## Основные опции DHCP сервера

В конфигурации DHCP-сервера R1 используются следующие опции:

| Опция DHCP | Значение | Описание |
|------------|----------|----------|
| `range` | `10.10.0.2 10.10.63.250` | Диапазон IP-адресов для динамической выдачи клиентам |
| `option routers` | `10.10.0.1` | Шлюз по умолчанию (Default Gateway) |
| `option domain-name-servers` | `10.10.0.1` | DNS сервер для разрешения имён |
| `option subnet-mask` | `255.255.192.0` | Маска подсети (/18) |
| `option broadcast-address` | `10.10.63.255` | Broadcast-адрес сети |

В конфигурации DHCP-сервера R2 используются следующие опции:

| Опция DHCP | Значение | Описание |
|------------|----------|----------|
| `range` | `10.20.0.2 10.20.0.50` | Диапазон IP-адресов для динамической выдачи клиентам |
| `option routers` | `10.20.0.1` | Шлюз по умолчанию (Default Gateway) |
| `option domain-name-servers` | `10.20.0.1` | DNS сервер для разрешения имён |
| `option subnet-mask` | `255.255.255.192` | Маска подсети (/18) |
| `option broadcast-address` | `10.20.0.50` | Broadcast-адрес сети |

## Part 7. **NAT**


![Рисунок](../datasets/photo77.png)  
*Рис. 77: В файле /etc/apache2/ports.conf на WS22 и R1 изменил строку Listen 80 на Listen 0.0.0.0:80*

![Рисунок](../datasets/photo78.png)  
*Рис. 78: Запустил веб-сервер Apache командой service apache2 start на WS22 и R1*

Добавил в фаервол на R2 следующие правила:

- Удалил все правила в таблице filter командой iptables -F

- Очистил таблицу NAT через iptables -F -t nat

- Установил политику DROP для цепочки FORWARD командой iptables --policy FORWARD DROP

![Рисунок](../datasets/photo_79.png)  
*Рис. 79: Запустил файл конфигурации фаервола

![Рисунок](../datasets/photo80.png)  
*Рис. 80: При запуске файла с этими правилами, WS22 не пингуется с R1.*

![Рисунок](../datasets/photo81.png)  
*Рис. 81: Разрешил маршрутизацию всех пакетов протокола ICMP*

![Рисунок](../datasets/photo82.png)  
*Рис. 82: При запуске файла с этими правилами, WS22 пингуется с R1*

- Включил SNAT с маскированием всех локальных IP из локальной сети за R2.

- Настроил DNAT на 8080 порт маршрутизатора r2 для предоставления доступа извне сети к веб-серверу Apache на WS22.

![Рисунок](../datasets/photo_83.png)  
*Рис. 83: Файл firewall.sh*

![Рисунок](../datasets/photo84.png)  
*Рис. 84: Cоединение по TCP для SNAT*

![Рисунок](../datasets/photo_85.png)  
*Рис. 85: Cоединение по TCP для DNAT*

---
![Рисунок](../datasets/photo86.png)  
*Рис. 86: Сохранил дампы образов виртуальных машин*

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

- Запустил на R2 фаервол с правилами из Части 7

![Рисунок](../datasets/photo_83.png)  
*Рис. 87: Файл firewall.sh*

![Рисунок](../datasets/photo87.png)  
*Рис. 88: Запустил веб-сервер Apache на WS22 только на localhost*

![Рисунок](../datasets/photo88.png)  
*Рис. 89: ssh -L 8080:127.0.0.1:80 ws22@10.20.0.3*

![Рисунок](../datasets/photo89.png)  
*Рис. 90: ssh -R 8080:127.0.0.1:80 ws22@10.20.0.3*

![Рисунок](../datasets/photo90.png)  
*Рис. 91: Вывод команды telnet*

![Рисунок](../datasets/photo91png.png)  
*Рис. 92: Вывод команды telnet*

![Рисунок](../datasets/photo92.png)  
*Рис. 93: Сохранил дампы образов виртуальных машин*